<!DOCTYPE html>
<html lang="es-VE">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Salomon Trujillo" />
    <meta name="description" content="Este es el juego Batalla Naval"/>
    <meta name="keywords" content="Batalla Naval, juego, taller"/>
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" href="https://static3.depositphotos.com/1007664/237/v/450/depositphotos_2376836-stock-illustration-battle-ship.jpg" type="image/png" sizes="16x16 32x32 64x64">
    <link rel="stylesheet" href="../estilos/style.css">
    <script src="../scripts/contador.js"></script>
    <title>BatallaNaval | Juego con dos</title>
</head>

<body>
    <div class="principal-jugar-dos">
        <header>
            <hgroup>
                <h1>Batalla Naval</h1>
                <h2>¡Sé un ganador!</h2>
            </hgroup>
            <nav class="opciones-navegación">
                <a href="reglas.html">REGLAS</a>
            </nav>
        </header>

        <main>
            <div class="contenedor-crear-unirse"></div>
            <div class="generar-codigo">
                <button id="crear-partida" class="server-operation">Crear Partida</button>
                <input type="text" id="id-partida" class="server-operation" placeholder="ID del juego" disabled />
            </div>

            <div class="unirse-a-juego">
                <button id="join-game" class="server-operation">Unirse a un juego existente</button>
                <input type="text" id="id-juego" class="server-operation" placeholder="ID del juego"/>
                <h3>Nombre:</h3>
                <input type="text" id="jugador1-name" class="server-operation" placeholder="Ingrese su nombre"/>
            </div>

            <div class="informacion-partida">
                <h1>INFORMACION DE PARTIDA</h1>
                <h3>PUNTOS: 000</h3>
            </div>

            <div id="turno">Turno de: Jugador 1</div>

            <div class="contenedor-principal">
                <div class="contenedor-barcos">
                    <div class="barcos"></div>
                </div>

                <div class="tableros">
                    <div class="contenedor-tablero">
                        <div class="jugador">
                            <h2 id="name-J1">Jugador 1</h2>
                            <div id="jugador1">60</div>
                        </div>
                        <div class="tablero-propio" id="tablero-propio"></div>
                    </div>

                    <div class="contenedor-tablero">
                        <div class="jugador">
                            <h2 id="name-J2">Jugador 2</h2>
                            <div id="jugador2">60</div>
                        </div>
                        <div class="tablero-enemigo" id="tablero-enemigo"></div>
                    </div>
                </div>
            </div>

            <div class="powerup">
                <a href="#">Power-ups disponibles</a>
                <a href="power-ups.html">POWER UPS</a>
            </div>

            <div class="conexion-ws">
                <div id="iniciarpartida">
                    <button id="iniciar-partida" class="server-operation" type="button" onclick="iniciarContador()">Jugar</button>
                </div>
                <div class="atacar-enemigo">
                    <button id="atacar-enemigo" class="server-operation">Atacar</button>
                    <input type="text" id="move" class="server-operation" placeholder="Movimiento (p. ej. A1)" />
                </div>
                <div class="salir-partida">
                    <button id="dejar-partida" class="server-operation" type="button">RENDIRSE</button>
                </div>
                <div id="cerrar-conexion">
                    <button id="cerrar-conexion" class="client-operation" type="button">Cerrar Conexión</button>
                </div>
            </div>
        </main>

        <footer>
            <h3>by: Ing. Salomón Trujillo | Program Web | Ucab</h3>
        </footer>
    </div>

    <script>
          let posicionesBarcosGlobal = []; // Aquí se almacenarán todas las posiciones de los barcos

      
      //TABLEROS Y BARCOS --------------------------------------------------------------------------------------------------------
      document.addEventListener("DOMContentLoaded", function () {
    const tableros = document.querySelectorAll(".tablero-propio, .tablero-enemigo");
    const letras = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"];
    const numeros = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
    const barcos = [
        { id: "ship1", href: "../images/ship1.png", width: 5, posiciones: [] },
        { id: "ship2", href: "../images/ship2.png", width: 4, posiciones: [] },
        { id: "ship3", href: "../images/ship3.png", width: 5, posiciones: [] },
        { id: "ship4", href: "../images/ship4.png", width: 4, posiciones: [] },
        { id: "ship5", href: "../images/ship5.png", width: 3, posiciones: [] }
    ];
    let barcosColocados = 0;
    let posicionesOcupadas = [];
    let barcosEnemigos = [];

    const barcoContainer = document.querySelector(".barcos");
    barcos.forEach(barco => {
        const img = document.createElement("img");
        img.src = barco.href;
        img.id = barco.id;
        img.className = "barco";
        img.draggable = true;
        img.setAttribute("data-width", barco.width);
        img.setAttribute("data-rotation", "0");
        img.onerror = function () {
            console.error("No se pudo cargar la imagen: " + barco.href);
        };
        barcoContainer.appendChild(img);
        img.addEventListener("dragstart", (e) => {
            if (barcosColocados >= 5) {
                e.preventDefault();
                alert("Ya has colocado el máximo de 5 barcos.");
                return;
            }
            e.dataTransfer.setData("text", barco.id);
        });
        img.addEventListener("click", function () {
            const currentRotation = parseInt(img.getAttribute("data-rotation") || "0");
            const newRotation = (currentRotation + 90) % 360;
            img.style.transform = `rotate(${newRotation}deg)`;
            img.setAttribute("data-rotation", newRotation);
        });
    });

    tableros.forEach(tablero => {
        for (let i = 0; i <= letras.length; i++) {
            const div = document.createElement("div");
            div.className = "posición header";
            if (i > 0) {
                div.textContent = letras[i - 1];
            }
            tablero.appendChild(div);
        }
        for (let i = 0; i < numeros.length; i++) {
            for (let j = 0; j <= letras.length; j++) {
                const div = document.createElement("div");
                if (j === 0) {
                    div.className = "posición header";
                    div.textContent = numeros[i];
                } else {
                    div.className = "posición";
                    div.id = `${letras[j - 1]}${numeros[i]}`;
                }
                tablero.appendChild(div);
            }
        }
    });

    function verificarPosicionOcupada(posicionId) {
        return posicionesOcupadas.includes(posicionId);
    }

    function agregarPosicionOcupada(posicionId) {
        if (!posicionesOcupadas.includes(posicionId)) {
            posicionesOcupadas.push(posicionId);
        }
    }

    document.addEventListener('dragover', function (e) {
        e.preventDefault();
    });

    document.addEventListener('drop', function (e) {
        const tableroPropio = document.querySelector(".tablero-propio");
        if (tableroPropio.contains(e.target) && e.target.classList.contains('posición')) {
            if (barcosColocados >= 5) {
                alert("Ya has colocado el máximo de 5 barcos.");
                return;
            }
            const barcoId = e.dataTransfer.getData("text");
            const barco = barcos.find(b => b.id === barcoId);
            const posicionId = e.target.id;
            const letra = posicionId.charAt(0);
            const numero = parseInt(posicionId.substring(1));
            if (letra === "A" || numero === 1) {
                alert("No puedes colocar el barco en la primera fila ni en la primera columna.");
                return;
            }
            if (verificarPosicionOcupada(posicionId)) {
                alert("Esta posición ya está ocupada.");
                return;
            }
            const startIdx = letras.indexOf(letra);
            if (startIdx + barco.width > letras.length) {
                alert("El barco no cabe en esta posición.");
                return;
            }
            const rotation = parseInt(document.getElementById(barco.id).getAttribute("data-rotation") || "0");
            let targetPositionX = e.target.offsetLeft;
            let targetPositionY = e.target.offsetTop;
            const posicionesBarco = calcularPosicionesOcupadas(posicionId, barco.width, rotation);
            console.log(`El barco ${barco.id} ha sido colocado en las siguientes posiciones:`);
            console.log(posicionesBarco);
            for (let posicion of posicionesBarco) {
                if (verificarPosicionOcupada(posicion)) {
                    alert("No puedes colocar el barco porque hay otro barco en las posiciones.");
                    return;
                }
            }
            const imgClone = document.getElementById(barco.id).cloneNode(true);
            imgClone.style.position = "absolute";
            imgClone.style.left = `${targetPositionX}px`;
            imgClone.style.top = `${targetPositionY}px`;
            tableroPropio.appendChild(imgClone);
            imgClone.draggable = false;
            imgClone.setAttribute("data-colocado", "true");
            const imgOriginal = document.getElementById(barco.id);
            imgOriginal.remove();
            barcosColocados++;
            posicionesBarco.forEach(p => agregarPosicionOcupada(p));
            imgClone.addEventListener('click', function () {
                imgClone.remove();
                barcosColocados--;
                posicionesBarco.forEach(p => {
                    const idx = posicionesOcupadas.indexOf(p);
                    if (idx !== -1) posicionesOcupadas.splice(idx, 1);
                });
                const imgOriginal = document.createElement("img");
                imgOriginal.src = barco.href;
                imgOriginal.id = barco.id;
                imgOriginal.className = "barco";
                imgOriginal.draggable = true;
                imgOriginal.setAttribute("data-width", barco.width);
                imgOriginal.setAttribute("data-rotation", "0");
                barcoContainer.appendChild(imgOriginal);
            });
            barcosEnemigos.push({ id: barco.id, posiciones: posicionesBarco });

            // Guardamos las posiciones en el array global
            posicionesBarcosGlobal.push(...posicionesBarco); 

        }
    });

    function calcularPosicionesOcupadas(posicionId, width, rotation) {
        const posiciones = [];
        const letra = posicionId.charAt(0);
        const numero = parseInt(posicionId.substring(1));
        const filaIndex = letras.indexOf(letra);
        for (let i = 0; i < width; i++) {
            if (rotation === 0) {
                const columna = numero + i;
                if (columna > 10) break;
                posiciones.push(`${letra}${columna}`);
            } else if (rotation === 90) {
                const fila = letras[filaIndex + i];
                if (!fila) break;
                posiciones.push(`${fila}${numero}`);
            }
        }
        return posiciones;
    }
});




      //TABLEROS Y BARCOS --------------------------------------------------------------------------------------------------------


      //CONEXION/SERVIDOR-----------------------------------------------------------------------------------------------------------------
        const WEBSOCKET_SCHEME = 'ws';
        const WEBSOCKET_SERVER = 'localhost';
        const WEBSOCKET_PORT = 9092;
        const WEBSOCKET_URL = `${WEBSOCKET_SCHEME}://${WEBSOCKET_SERVER}:${WEBSOCKET_PORT}`;
        let modojuego = true;
        let minombre = document.getElementById('jugador1-name');
        let hit = false;
        const socket = new WebSocket(WEBSOCKET_URL);
        console.log('Posiciones de los barcos: ', posicionesBarcosGlobal);

        socket.addEventListener('open', () => {
            console.log(`%cConexión exitosa en ${WEBSOCKET_URL}`, 'color: #99ff00');
        });

        socket.addEventListener('message', (event) => {
            const message = JSON.parse(event.data);
            console.log('%c<- %cMensaje recibido desde el servidor:', 'color: #99ff00', 'color: inherit', message);

            if (message.type === 'gameCreated') {
                const gameIdInput = document.getElementById('id-partida');
                const playerNameElement = document.getElementById('name-J1');

                gameIdInput.value = message.gameId;
                playerNameElement.innerText = `Jugador 1: ${message.playerName}`;
            }

            if (message.type === 'playerJoined') {
                const playerNameElement = document.getElementById('name-J2');
                playerNameElement.innerText = `Jugador 2: ${message.playerName}`;
            }

            if (message.type === 'move') {
                let minombre = document.getElementById('jugador1-name').value;
                let nombreEnemigo = message.playerName;
                const myPlayerName = modojuego ? playerName1 : playerName1;
                
                // Si el mensaje es de un jugador diferente al actual, actualiza el tablero correspondiente
                if (message.playerName !== minombre) {
                  for (let i = 0; i < posicionesBarcosGlobal.length; i++) {
                    if (posicionesBarcosGlobal[i] === message.move) {
                      message.type = 'estadoHit';
                      hit = true;
                      break;
                    } else {
                      message.type = 'estadoHit';
                      hit = false;
                    }
                  }
                    const message = { type: 'hit', move: message.move, hit };
                    socket.send(JSON.stringify(message));
                    actualizarTableroJugador(message.move, 'tablero-propio', hit);
                }
            }

        });

        document.getElementById('crear-partida').addEventListener('click', () => {
            const playerName = document.getElementById('jugador1-name').value;
            const size = 2;
            modojuego = true;

            if (playerName.trim()) {
                const message = { type: 'create', playerName, size };
                socket.send(JSON.stringify(message));
            } else {
                alert("Por favor ingresa tu nombre antes de crear un juego.");
            }
        });

        document.getElementById('join-game').addEventListener('click', () => {
            const playerName = document.getElementById('jugador1-name').value;
            const gameId = document.getElementById('id-juego').value;
            const size = 2;
            modojuego = false;

            if (playerName && gameId) {
                socket.send(JSON.stringify({ type: 'join', gameId, playerName, size }));
            } else {
                alert("Por favor ingresa tu nombre y el ID del juego antes de unirte.");
            }
        });

        let playerName1 = '';
        let playerName2 = '';

        document.getElementById('iniciar-partida').addEventListener('click', () => {
            const gameId = modojuego ? document.getElementById('id-partida').value : document.getElementById('id-juego').value;
            if (modojuego) {
                socket.send(JSON.stringify({ type: 'start', gameId }));
                console.log('Empezó el juego');
                playerName1 = document.getElementById('jugador1-name').value;
            } else {
                socket.send(JSON.stringify({ type: 'start', gameId }));
                console.log('Empezó el juego');
                playerName2 = document.getElementById('jugador1-name').value;
            }
        });

        // Manejar ataques: Cuando un jugador hace clic en "atacar-enemigo"
        document.getElementById('atacar-enemigo').addEventListener('click', () => {
            const gameId = modojuego ? document.getElementById('id-partida').value : document.getElementById('id-juego').value;
            const move = document.getElementById('move').value.toUpperCase();

            const playerName = document.getElementById('jugador1-name').value;

            if (/^[A-J]([1-9]|10)$/.test(move)) {
                socket.send(JSON.stringify({ type: 'move', gameId, move, playerName }));

                // Actualiza inmediatamente el tablero del enemigo con la jugada del jugador
                actualizarTableroJugador(move, 'tablero-enemigo', true);
            } else {
                alert('Posición no válida');
            }
        });

        function actualizarTableroJugador(move, tableroId, isHit) {
            const playerBoard = document.getElementById(tableroId);
            const cell = playerBoard.querySelector(`#${move}`);

            if (isHit !== undefined) {
                // Si es un "hit", actualizar la celda con el impacto (flama)
                if (isHit) {
                    const img = document.createElement('img');
                    img.src = "../images/flama.gif";
                    img.style.width = "110%";
                    cell.innerHTML = '';
                    cell.appendChild(img);
                    cell.style.color = 'red';
                } else {
                    // Si no es un "hit", mostrar "O" en la celda
                    cell.textContent = 'O';
                    cell.style.color = 'blue';
                }
            } else {
                // Si no es un hit ni un fallo, marca la celda con un "X" para indicar que el jugador ha hecho un movimiento
                cell.textContent = 'X';
                cell.style.color = 'grey'; // Color temporal para diferenciar los ataques enviados
            }
        }
    </script>
</body>
</html>
